<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Empréstimos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <style>
      body {
    background-image: url("img/vip.webp");
    background-size: cover; /* Ajusta a imagem para cobrir toda a tela */
    background-position: center; /* Centraliza a imagem */
    background-repeat: no-repeat; /* Evita repetição da imagem */
}

        .container {
            max-width: 800px; /* Ajusta a largura máxima do contêiner */
            margin-top: 20px;
        }
        .card-cliente {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background: #fff;
            transition: transform 0.2s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .card-cliente:hover {
            transform: scale(1.02);
        }
        .status-pago {
            color: green;
            font-weight: bold;
        }
        .summary-list {
            margin-top: 20px;
            list-style-type: none;
            padding: 0;
        }
        .summary-list li {
            background: #ffffff;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s;
            box-shadow: 0 2px 5px rgb(216, 10, 10);
        }
        .summary-list li:hover {
            transform: scale(1.02);
        }
        .img-preview {
            max-width: 100px; /* Limita a largura da imagem */
            margin-top: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
        }
        .form-control {
            border-radius: 5px;
        }
        .btn {
            border-radius: 5px;
        }
        .foto-perfil {
            width: 60px; /* Tamanho da foto de perfil */
            height: 60px; /* Tamanho da foto de perfil */
            border-radius: 50%; /* Formato redondo */
            object-fit: cover; /* Cobre o espaço sem distorcer */
            border: 2px solid #ccc; /* Borda da foto */
            cursor: pointer; /* Muda o cursor para indicar que é clicável */
        }
        .status-ativo {
            color: green;
            font-weight: bold;
        }
        .garantia-imagem {
            margin-top: 10px;
        }
        .foto-perfil-zoom {
            display: none; /* Inicialmente escondido */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
        }
        .foto-perfil-zoom img {
            max-width: 90%;
            max-height: 90%;
        }
        h2{
            box-shadow:rgb(196, 15, 15) ;
            color: #ffffff;
            background-color: rgb(45, 0, 247);
        }
        h4{
            box-shadow:rgb(196, 15, 15) ;
            color: #000000;
            background-color: rgb(115, 255, 0);
            font-family: algerian;
            font-style: italic;
        
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center"><i class="fas fa-money-bill-wave"></i> Gestão de Empréstimos</h2>
        <div class="card p-3">
            <h4><i class="fas fa-user-plus"></i> Adicionar Cliente</h4>
            <div class="mb-2">
                <label>Nome do Cliente:</label>
                <input type="text" id="nome" class="form-control">
            </div>
            <div class="mb-2">
                <label>Valor do Empréstimo:</label>
                <input type="number" id="valor" class="form-control">
            </div>
            <div class="mb-2">
                <label>Foto de Perfil:</label>
                <input type="file" id="fotoPerfil" class="form-control" accept="image/*">
            </div>
            <div class="mb-2">
                <label>Imagem de Garantia:</label>
                <input type="file" id="imagemGarantia" class="form-control" accept="image/*">
            </div>
            <button class="btn btn-primary" onclick="emprestar()"><i class="fas fa-plus"></i> Emprestar</button>
        </div>
        
        <h4 class="mt-4"><i class="fas fa-list"></i> Lista de Clientes</h4>
        <div id="listaClientes"></div>

        <h4 class="mt-4"><i class="fas fa-chart-pie"></i> Resumo Financeiro</h4>
        <ul class="summary-list">
            <li><strong>Total de Clientes:</strong> <span id="totalClientes">0</span></li>
            <li><strong>Total de Dívidas:</strong> <span id="totalDividas">0.00</span></li>
            <li><strong>Total de Reembolsos:</strong> <span id="totalReembolsos">0.00</span></li>
            <li><strong>Saldo Disponível:</strong> <span id="saldoDisponivel">0.00</span></li>
        </ul>
    </div>

    <div class="foto-perfil-zoom" id="fotoPerfilZoom" onclick="fecharZoom()">
        <img id="imagemZoom" src="" alt="Foto de Perfil Ampliada">
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD8XOHaLCzNLDrIlHG3em4g4gyYIKTLWpQ",
            authDomain: "xitique-61310.firebaseapp.com",
            databaseURL: "https://xitique-61310-default-rtdb.firebaseio.com",
            projectId: "xitique-61310",
            storageBucket: "xitique-61310.appspot.com",
            messagingSenderId: "331274991404",
            appId: "1:331274991404:web:2fec0eb082d3fe0b33de89",
            measurementId: "G-DFDMBKW1RK"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();

        function emprestar() {
            let nome = document.getElementById("nome").value;
            let valor = parseFloat(document.getElementById("valor").value);
            let fotoPerfil = document.getElementById("fotoPerfil").files[0];
            let imagemGarantia = document.getElementById("imagemGarantia").files[0];
            let juros = valor * 0.2;
            let totalPagar = valor + juros;
            let dataEmprestimo = new Date().toLocaleDateString();
            
            if (!nome || isNaN(valor) || valor <= 0) {
                Swal.fire('Erro', 'Preencha os campos corretamente!', 'error');
                return;
            }

            // Upload da foto de perfil
            let fotoPerfilRef = storage.ref(`fotosPerfil/${nome}_${Date.now()}`);
            let imagemGarantiaRef = storage.ref(`imagensGarantia/${nome}_${Date.now()}`);

            let uploadTasks = [];

            if (fotoPerfil) {
                uploadTasks.push(fotoPerfilRef.put(fotoPerfil).then(snapshot => snapshot.ref.getDownloadURL()));
            } else {
                uploadTasks.push(Promise.resolve(null)); // Se não houver foto, resolve com null
            }

            if (imagemGarantia) {
                uploadTasks.push(imagemGarantiaRef.put(imagemGarantia).then(snapshot => snapshot.ref.getDownloadURL()));
            } else {
                uploadTasks.push(Promise.resolve(null)); // Se não houver imagem, resolve com null
            }

            Promise.all(uploadTasks).then(urls => {
                let novoEmprestimo = db.ref("emprestimos").push();
                novoEmprestimo.set({
                    nome: nome,
                    valor: valor,
                    totalPagar: totalPagar,
                    status: "Pendente",
                    data: dataEmprestimo,
                    historicoReembolsos: [],
                    historicoAdicoes: [],
                    fotoPerfil: urls[0], // URL da foto de perfil
                    imagemGarantia: urls[1] // URL da imagem de garantia
                });
                document.getElementById("nome").value = "";
                document.getElementById("valor").value = "";
                document.getElementById("fotoPerfil").value = "";
                document.getElementById("imagemGarantia").value = "";
            });
        }

        function carregarEmprestimos() {
            db.ref("emprestimos").on("value", (snapshot) => {
                let lista = document.getElementById("listaClientes");
                lista.innerHTML = "";
                let totalDividas = 0;
                let totalReembolsos = 0;

                snapshot.forEach((childSnapshot) => {
                    let data = childSnapshot.val();
                    let historicoReembolsos = data.historicoReembolsos ? data.historicoReembolsos.map(h => `<li>${h}</li>`).join('') : '';
                    let historicoAdicoes = data.historicoAdicoes ? data.historicoAdicoes.map(h => `<li>${h}</li>`).join('') : '';
                    let statusClass = data.status === "Pago" ? "status-pago" : "";
                    
                    // Se o status for "Pago", exibe o valor emprestado como zero
                    let valorEmprestado = data.status === "Pago" ? 0 : data.valor.toFixed(2);
                    
                    lista.innerHTML += `
                        <div class="card-cliente">
                            <div class="text-center">
                                ${data.fotoPerfil ? `<img src="${data.fotoPerfil}" alt="Foto de Perfil" class="foto-perfil" onclick="mostrarZoom('${data.fotoPerfil}')">` : ''}
                                ${data.status === "Pendente" ? '<p class="status-ativo">Ativo <span style="color: green;">●</span></p>' : ''}
                            </div>
                            <p><strong>Nome:</strong> ${data.nome}</p>
                            <p><strong>Valor Emprestado:</strong> ${valorEmprestado}</p>
                            <p><strong>Total a Pagar:</strong> ${data.totalPagar.toFixed(2)}</p>
                            <p><strong>Status:</strong> <span class="${statusClass}">${data.status}</span></p>
                            <p><strong>Data:</strong> ${data.data}</p>
                            <div class="garantia-imagem">
                                ${data.imagemGarantia ? `<img src="${data.imagemGarantia}" alt="Imagem de Garantia" class="img-preview"><p>Item de Garantia</p>` : ''}
                            </div>
                            <button class="btn btn-success btn-sm" onclick="reembolsar('${childSnapshot.key}', ${data.totalPagar})"><i class="fas fa-dollar-sign"></i> Reembolsar</button>
                            <button class="btn btn-warning btn-sm" onclick="adicionarValor('${childSnapshot.key}', ${data.valor})"><i class="fas fa-plus-circle"></i> Adicionar Valor</button>
                            <button class="btn btn-danger btn-sm" onclick="excluirEmprestimo('${childSnapshot.key}')"><i class="fas fa-trash"></i> Excluir</button>
                            <h6>Histórico de Reembolsos:</h6>
                            <ul>${historicoReembolsos}</ul>
                            <h6>Histórico de Adições:</h6>
                            <ul>${historicoAdicoes}</ul>
                        </div>`;
                    
                    // Atualiza o total de dívidas
                    totalDividas += data.totalPagar;
                });

                // Atualiza o total de clientes
                document.getElementById("totalClientes").innerText = snapshot.numChildren();
                document.getElementById("totalDividas").innerText = totalDividas.toFixed(2);
                document.getElementById("totalReembolsos").innerText = totalReembolsos.toFixed(2);
                atualizarSaldoDisponivel();
            });
        }

        function atualizarSaldoDisponivel() {
            db.ref("saldoDisponivel").once("value", (snapshot) => {
                let saldo = snapshot.val() || 0;
                document.getElementById("saldoDisponivel").innerText = saldo.toFixed(2);
            });
        }

        function reembolsar(id, total) {
            Swal.fire({
                title: 'Reembolsar',
                input: 'number',
                showCancelButton: true,
                confirmButtonText: 'Confirmar',
                preConfirm: (valorPago) => {
                    valorPago = parseFloat(valorPago);
                    if (isNaN(valorPago) || valorPago <= 0) {
                        Swal.fire('Erro', 'Insira um valor válido!', 'error');
                        return;
                    }
                    db.ref(`emprestimos/${id}`).once("value", (snapshot) => {
                        let data = snapshot.val();
                        let restante = data.totalPagar - valorPago;
                        let historico = data.historicoReembolsos || [];
                        historico.push(`${new Date().toLocaleDateString()} - Reembolsado: ${valorPago}`);
                        let status = restante <= 0 ? "Pago" : "Pendente";
                        db.ref(`emprestimos/${id}`).update({ 
                            totalPagar: Math.max(0, restante), 
                            status, 
                            historicoReembolsos: historico 
                        });

                        // Atualiza o total de reembolsos
                        let totalReembolsos = parseFloat(document.getElementById("totalReembolsos").innerText) + valorPago;
                        document.getElementById("totalReembolsos").innerText = totalReembolsos.toFixed(2);
                    });
                }
            });
        }
        
        function adicionarValor(id, valorAtual) {
            Swal.fire({
                title: 'Adicionar Valor',
                input: 'number',
                showCancelButton: true,
                confirmButtonText: 'Adicionar',
                preConfirm: (valorAdicionado) => {
                    valorAdicionado = parseFloat(valorAdicionado);
                    if (isNaN(valorAdicionado) || valorAdicionado <= 0) {
                        Swal.fire('Erro', 'Insira um valor válido!', 'error');
                        return;
                    }
                    db.ref(`emprestimos/${id}`).once("value", (snapshot) => {
                        let data = snapshot.val();
                        let historico = data.historicoAdicoes || [];
                        historico.push(`${new Date().toLocaleDateString()} - Adicionado: ${valorAdicionado}`);
                        db.ref(`emprestimos/${id}`).update({ 
                            valor: data.valor + valorAdicionado, 
                            totalPagar: (data.valor + valorAdicionado) * 1.2, 
                            historicoAdicoes: historico 
                        });
                    });
                }
            });
        }

        function excluirEmprestimo(id) {
            Swal.fire({
                title: 'Tem certeza que deseja excluir este empréstimo?',
                text: "Esta ação não pode ser desfeita!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sim, excluir!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref(`emprestimos/${id}`).remove().then(() => {
                        Swal.fire('Excluído!', 'O empréstimo foi excluído com sucesso.', 'success');
                    }).catch((error) => {
                        Swal.fire('Erro!', 'Ocorreu um erro ao excluir o empréstimo.', 'error');
                    });
                }
            });
        }

        function mostrarZoom(url) {
            const imagemZoom = document.getElementById("imagemZoom");
            const fotoPerfilZoom = document.getElementById("fotoPerfilZoom");
            imagemZoom.src = url;
            fotoPerfilZoom.style.display = "block"; // Exibe a imagem em zoom
        }

        function fecharZoom() {
            const fotoPerfilZoom = document.getElementById("fotoPerfilZoom");
            fotoPerfilZoom.style.display = "none"; // Esconde a imagem em zoom
        }

        window.onload = carregarEmprestimos;
    </script>
</body>
</html>
